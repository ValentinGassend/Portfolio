# .github/workflows/deploy.yml
name: Deploy to Infomaniak

on:
  push:
    branches: [ main ]
  # Retirez pull_request si vous ne voulez d√©ployer que sur push vers main
  # pull_request:
  #   branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Ne d√©ployer que sur push vers main (pas sur PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Fix permissions
        run: chmod +x deploy.js

      - name: Generate optimized deployment
        run: npm run deploy



      # Cr√©er le fichier .htaccess dans dist avant le d√©ploiement
      - name: Create .htaccess for React Router
        run: |
          cat > dist/.htaccess << 'EOF'
          # .htaccess OPTIMIS√â - Corrige cache polices Lighthouse (245 KiB)
          RewriteEngine On
          
          # ========================================
          # üéØ CACHE POLICES BRICOLAGE - PRIORIT√â LIGHTHOUSE
          # ========================================
          
          <IfModule mod_expires.c>
              ExpiresActive On
          
              # ‚úÖ POLICES - Cache 1 an (corrige les 245 KiB de Lighthouse)
              ExpiresByType font/woff2 "access plus 1 year"
              ExpiresByType font/woff "access plus 1 year"
              ExpiresByType font/ttf "access plus 1 year"
              ExpiresByType font/otf "access plus 1 year"
              ExpiresByType font/eot "access plus 1 year"
          
              # Types MIME alternatifs (important pour Infomaniak)
              ExpiresByType application/font-woff2 "access plus 1 year"
              ExpiresByType application/font-woff "access plus 1 year"
              ExpiresByType application/font-sfnt "access plus 1 year"
              ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
              ExpiresByType application/x-font-woff "access plus 1 year"
              ExpiresByType application/x-font-woff2 "access plus 1 year"
          
              # CSS et JS avec hash
              ExpiresByType text/css "access plus 1 year"
              ExpiresByType application/javascript "access plus 1 year"
              ExpiresByType application/x-javascript "access plus 1 year"
          
              # Images
              ExpiresByType image/png "access plus 1 year"
              ExpiresByType image/jpg "access plus 1 year"
              ExpiresByType image/jpeg "access plus 1 year"
              ExpiresByType image/gif "access plus 1 year"
              ExpiresByType image/webp "access plus 1 year"
              ExpiresByType image/avif "access plus 1 year"
              ExpiresByType image/svg+xml "access plus 1 year"
          
              # HTML avec revalidation
              ExpiresByType text/html "access plus 1 hour"
              ExpiresByType application/xml "access plus 1 day"
              ExpiresByType text/xml "access plus 1 day"
          </IfModule>
          
          # ========================================
          # üéØ HEADERS DE CACHE EXPLICITES (corrige "Cache TTL: None")
          # ========================================
          
          <IfModule mod_headers.c>
              # ‚úÖ POLICES BRICOLAGE - Headers de cache explicites
              <FilesMatch "\.(woff2|woff|ttf|otf|eot)$">
                  # Cache immutable 1 an - Corrige "Cache TTL: None" ‚Üí "365 days"
                  Header set Cache-Control "public, max-age=31536000, immutable"
          
                  # CORS pour polices cross-domain
                  Header set Access-Control-Allow-Origin "*"
                  Header set Access-Control-Allow-Methods "GET, OPTIONS"
                  Header set Access-Control-Allow-Headers "Content-Type, Accept, Origin"
          
                  # Optimisations
                  Header set Vary "Accept-Encoding"
                  Header set X-Content-Type-Options "nosniff"
          
                  # Debug Lighthouse (visible dans Network tab)
                  Header set X-Font-Cache-Lighthouse "245KB-saved"
                  Header set X-Deployment "GitHub-Actions-Infomaniak"
              </FilesMatch>
          
              # ‚úÖ Cache sp√©cifique pour dossier /font/Bricolage*
              <LocationMatch "^/font/Bricolage.*\.(woff2|woff|ttf|otf)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
                  Header set X-Font-Family "Bricolage-Grotesque"
                  Header set X-Lighthouse-Fixed "true"
              </LocationMatch>
          
              # CSS et JS avec versioning
              <FilesMatch "\.(css|js)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
                  Header set X-Asset-Cache "1-year"
              </FilesMatch>
          
              # Images
              <FilesMatch "\.(png|jpg|jpeg|gif|svg|webp|avif)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
                  Header set X-Image-Cache "1-year"
              </FilesMatch>
          
              # HTML avec revalidation
              <FilesMatch "\.html$">
                  Header set Cache-Control "public, max-age=3600, must-revalidate"
                  Header set X-HTML-Cache "1-hour"
              </FilesMatch>
          
              # Headers de s√©curit√©
              Header always set X-Content-Type-Options nosniff
              Header always set X-Frame-Options SAMEORIGIN
              Header always set X-XSS-Protection "1; mode=block"
              Header always set Referrer-Policy "strict-origin-when-cross-origin"
              Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
          </IfModule>
          
          # ========================================
          # üéØ TYPES MIME COMPLETS POUR POLICES
          # ========================================
          
          <IfModule mod_mime.c>
              # Types MIME modernes pour polices
              AddType font/woff2 .woff2
              AddType font/woff .woff
              AddType font/ttf .ttf
              AddType font/otf .otf
              AddType font/eot .eot
          
              # Types MIME alternatifs (pour compatibilit√© Infomaniak)
              AddType application/font-woff2 .woff2
              AddType application/font-woff .woff
              AddType application/font-sfnt .ttf .otf
              AddType application/vnd.ms-fontobject .eot
              AddType application/x-font-woff .woff
              AddType application/x-font-woff2 .woff2
              AddType application/x-font-ttf .ttf
              AddType application/x-font-otf .otf
          
              # Autres types importants
              AddType image/webp .webp
              AddType image/avif .avif
              AddType application/manifest+json .webmanifest
              AddType application/json .json
          
              AddDefaultCharset UTF-8
          </IfModule>
          
          # ========================================
          # üéØ COMPRESSION OPTIMIS√âE
          # ========================================
          
          <IfModule mod_deflate.c>
              # Compression pour fichiers texte
              AddOutputFilterByType DEFLATE text/plain
              AddOutputFilterByType DEFLATE text/html
              AddOutputFilterByType DEFLATE text/xml
              AddOutputFilterByType DEFLATE text/css
              AddOutputFilterByType DEFLATE application/xml
              AddOutputFilterByType DEFLATE application/xhtml+xml
              AddOutputFilterByType DEFLATE application/rss+xml
              AddOutputFilterByType DEFLATE application/javascript
              AddOutputFilterByType DEFLATE application/x-javascript
              AddOutputFilterByType DEFLATE application/json
              AddOutputFilterByType DEFLATE image/svg+xml
          
              # ‚úÖ Exclure les polices de la compression (d√©j√† optimis√©es)
              SetEnvIfNoCase Request_URI \.(?:woff|woff2|ttf|otf|eot)$ no-gzip dont-vary
              SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|avif|zip|gz|rar|bz2|7z)$ no-gzip dont-vary
          </IfModule>
          
          # ========================================
          # üéØ GESTION DES ROUTES REACT ROUTER
          # ========================================
          
          # Gestion des routes SPA (apr√®s les r√®gles de cache)
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/font/
          RewriteCond %{REQUEST_URI} !^/assets/
          RewriteCond %{REQUEST_URI} !^/img/
          RewriteRule . /index.html [L]
          
          # ========================================
          # üéØ S√âCURIT√â ET PROTECTION
          # ========================================
          
          # Bloquer acc√®s aux fichiers sensibles
          <FilesMatch "^\.">
              Order allow,deny
              Deny from all
          </FilesMatch>
          
          # Protection des logs et configs
          <FilesMatch "\.(env|git|htaccess|htpasswd|log|ini|conf|bak|sql)$">
              Order allow,deny
              Deny from all
          </FilesMatch>
          
          # Bloquer user-agents malveillants
          <IfModule mod_setenvif.c>
              SetEnvIfNoCase User-Agent "^$" bad_bot
              SetEnvIfNoCase User-Agent "wget" bad_bot
              SetEnvIfNoCase User-Agent "curl" bad_bot=curl_allowed
              Order allow,deny
              Allow from all
              Deny from env=bad_bot
          </IfModule>
          EOF
    

      - name: Deploy to Infomaniak via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: /sites/valentingassend.com/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
            **/Thumbs.db
          # Options de s√©curit√©
          security: strict
          # Timeout plus long pour les gros sites
          timeout: 180000

      - name: Verify deployment
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Your site should be available at: https://valentingassend.com"