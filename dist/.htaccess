# .htaccess OPTIMISÃ‰ POUR CACHE DES POLICES
# Corrige le problÃ¨me Lighthouse "Utiliser des durÃ©es de mise en cache efficaces"

RewriteEngine On

# ========================================
# ðŸŽ¯ CACHE POLICES - PRIORITÃ‰ ABSOLUE
# ========================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # âœ… POLICES - Cache 1 an (365 jours) - TOUS les formats
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/eot "access plus 1 year"
    
    # âœ… POLICES - Types MIME alternatifs
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-sfnt "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType application/x-font-woff2 "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType application/x-font-otf "access plus 1 year"
    
    # âœ… CSS et JS avec hash - Cache immutable
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    
    # âœ… IMAGES - Cache long
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # âœ… HTML - Cache court avec revalidation
    ExpiresByType text/html "access plus 1 hour"
    
    # âœ… Fichiers SEO
    ExpiresByType application/xml "access plus 1 day"
    ExpiresByType text/xml "access plus 1 day"
</IfModule>

# ========================================
# ðŸŽ¯ HEADERS DE CACHE EXPLICITES
# ========================================

<IfModule mod_headers.c>
    # âœ… POLICES - Headers de cache explicites et CORS
    <FilesMatch ".(woff2|woff|ttf|otf|eot)$">
        # Cache immutable 1 an
        Header set Cache-Control "public, max-age=31536000, immutable"
        
        # CORS pour polices cross-domain
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Accept, Origin"
        
        # Optimisations compression
        Header set Vary "Accept-Encoding"
        
        # SÃ©curitÃ©
        Header set X-Content-Type-Options "nosniff"
        
        # Debug (Ã  supprimer en production)
        Header set X-Font-Cache "1-year-immutable"
    </FilesMatch>
    
    # âœ… CSS et JS avec hash
    <FilesMatch ".(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Asset-Cache "1-year-immutable"
    </FilesMatch>
    
    # âœ… IMAGES
    <FilesMatch ".(png|jpg|jpeg|gif|svg|webp|avif)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header set X-Image-Cache "1-year-immutable"
    </FilesMatch>
    
    # âœ… HTML avec revalidation
    <FilesMatch ".html$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
        Header set X-HTML-Cache "1-hour-revalidate"
    </FilesMatch>
    
    # âœ… Headers de sÃ©curitÃ© globaux
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# ========================================
# ðŸŽ¯ TYPES MIME COMPLETS POUR POLICES
# ========================================

<IfModule mod_mime.c>
    # âœ… Types MIME modernes pour polices
    AddType font/woff2 .woff2
    AddType font/woff .woff
    AddType font/ttf .ttf
    AddType font/otf .otf
    AddType font/eot .eot
    
    # âœ… Types MIME alternatifs
    AddType application/font-woff2 .woff2
    AddType application/font-woff .woff
    AddType application/font-sfnt .ttf .otf
    AddType application/vnd.ms-fontobject .eot
    AddType application/x-font-woff .woff
    AddType application/x-font-woff2 .woff2
    AddType application/x-font-ttf .ttf
    AddType application/x-font-otf .otf
    
    # âœ… Autres types importants
    AddType image/webp .webp
    AddType image/avif .avif
    AddType application/manifest+json .webmanifest
    AddType application/json .json
    
    # âœ… Charset par dÃ©faut
    AddDefaultCharset UTF-8
</IfModule>

# ========================================
# ðŸŽ¯ COMPRESSION OPTIMISÃ‰E
# ========================================

<IfModule mod_deflate.c>
    # âœ… Compression pour fichiers texte
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # âœ… Exclure les polices de la compression (dÃ©jÃ  optimisÃ©es)
    SetEnvIfNoCase Request_URI .(?:woff|woff2|ttf|otf|eot)$ no-gzip dont-vary
    
    # âœ… Exclure autres fichiers binaires
    SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png|webp|avif|zip|gz|rar|bz2|7z)$ no-gzip dont-vary
</IfModule>

# ========================================
# ðŸŽ¯ OPTIMISATIONS SPÃ‰CIFIQUES BRICOLAGE
# ========================================

# âœ… Cache spÃ©cifique pour les polices Bricolage Grotesque
<LocationMatch "^/font/Bricolage.*.(woff2|woff|ttf|otf)$">
    ExpiresDefault "access plus 1 year"
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set X-Font-Family "Bricolage-Grotesque"
    Header set X-Font-Cache-Optimized "true"
</LocationMatch>

# ========================================
# ðŸŽ¯ GESTION DES ROUTES REACT
# ========================================

# âœ… Redirection SPA (aprÃ¨s les rÃ¨gles de cache)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/font/
RewriteCond %{REQUEST_URI} !^/assets/
RewriteRule . /index.html [L]

# ========================================
# ðŸŽ¯ RÃˆGLES DE SÃ‰CURITÃ‰
# ========================================

# âœ… Bloquer accÃ¨s aux fichiers sensibles
<FilesMatch "^.">
    Order allow,deny
    Deny from all
</FilesMatch>

# âœ… Protection des logs et configs
<FilesMatch ".(env|git|htaccess|htpasswd|log|ini|conf)$">
    Order allow,deny
    Deny from all
</FilesMatch>